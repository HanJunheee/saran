<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>舍廊(サラン) 注文レシート</title>
  <!-- 확대/축소 방지: user-scalable=no / maximum-scale=1.0 -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- 현대적인 웹 폰트 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;600&display=swap"
    rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      touch-action: manipulation; /* 더블탭 제스처 최소화 */
    }

    body {
      margin: 0;
      padding: 12px 8px;
      font-family: "Inter", "Noto Sans KR", -apple-system, BlinkMacSystemFont,
      "Apple SD Gothic Neo", system-ui, sans-serif;
      background: radial-gradient(circle at top, #e5e7eb 0, #d1d5db 35%, #9ca3af 100%);
      display: flex;
      justify-content: center;
      color: #111827;
    }

    .app {
      width: 100%;
      max-width: 540px;
      background: #f9fafb;
      padding: 14px 12px 12px 12px;
      border-radius: 18px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.25),
        0 0 0 1px rgba(148, 163, 184, 0.4);
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 1.3rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: #0f172a;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel {
      padding: 10px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
    }

    .panel-title {
      font-size: 0.82rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ef4444, #fb923c);
    }

    /* 테이블 선택 */
    .table-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px;
      margin-bottom: 8px;
    }

    .table-btn {
      padding: 8px 6px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      color: #374151;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      position: relative; /* X 아이콘 배치용 */
      padding-right: 22px; /* 오른쪽 X 공간 */
    }

    .table-btn.active {
      background: radial-gradient(circle at top left, #fb923c, #ef4444);
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 10px 18px rgba(239, 68, 68, 0.35);
    }

    .table-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.18);
    }

    /* 카운터 삭제 X */
    .table-close {
      position: absolute;
      top: 3px;
      right: 6px;
      font-size: 0.72rem;
      color: #9ca3af;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      user-select: none;
    }

    .table-close:hover {
      color: #f97316;
    }

    .small-btn {
      padding: 5px 10px;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
    }

    .small-btn::before {
      content: "+";
      font-weight: 600;
      font-size: 0.8rem;
    }

    .small-btn:hover {
      background: #e5e7eb;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1);
    }

    .small-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    /* 합계 / 飲み放題 */
    .current-table-name {
      font-size: 0.83rem;
      margin-bottom: 5px;
      color: #4b5563;
    }

    .total-amount {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    .summary-list {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 6px;
      padding-right: 4px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      padding: 5px 8px;
      border-bottom: 1px solid #eef0f3;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-name {
      max-width: 58%;
      color: #111827;
    }

    .summary-info {
      white-space: nowrap;
      margin-left: 4px;
      color: #4b5563;
    }

    .delete-btn {
      margin-left: 6px;
      padding: 2px 8px;
      font-size: 0.72rem;
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #b91c1c;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    .delete-btn:hover {
      background: #fee2e2;
    }

    .delete-btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .reset-btn {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, box-shadow 0.1s ease, transform 0.05s ease;
    }

    .reset-btn::before {
      content: "↺";
      font-size: 0.82rem;
    }

    .reset-btn:hover {
      background: #f3f4f6;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    }

    .reset-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .nomihodai-info {
      margin-top: 8px;
      padding: 7px 8px;
      background: #fffbeb;
      border-radius: 10px;
      border: 1px solid #facc15;
      font-size: 0.76rem;
      line-height: 1.5;
      color: #78350f;
    }

    .nomihodai-info strong {
      font-weight: 600;
    }

    .nomihodai-memo {
      width: 100%;
      margin-top: 5px;
      font-size: 0.76rem;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      resize: vertical;
      min-height: 44px;
      font-family: inherit;
      background: #fffef5;
    }

    /* 메뉴 패널 */
    .menu-panel {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .menu-header-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }

    .menu-note {
      font-size: 0.72rem;
      color: #6b7280;
    }

    .category {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      margin-bottom: 6px;
      overflow: hidden;
      background: #f9fafb;
    }

    .category-header {
      width: 100%;
      text-align: left;
      padding: 7px 9px;
      background: linear-gradient(135deg, #f9fafb, #e5e7eb);
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #111827;
    }

    .category-header span {
      pointer-events: none;
    }

    .category-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-top: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .category-body.open {
      max-height: 1200px;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 9px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.78rem;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-left {
      display: flex;
      flex-direction: column;
    }

    .menu-name {
      font-weight: 500;
      color: #111827;
    }

    .menu-price {
      color: #6b7280;
      font-size: 0.72rem;
      margin-top: 1px;
    }

    .menu-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .qty-display {
      min-width: 22px;
      text-align: center;
      font-size: 0.78rem;
      color: #111827;
    }

    .qty-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #374151;
      transition: background 0.12s ease, transform 0.05s ease, box-shadow 0.1s ease;
    }

    .qty-btn:hover {
      background: #e5e7eb;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
    }

    .qty-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .soft-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .soft-input-row,
    .custom-input-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      width: 100%;
    }

    .soft-input-row input,
    .custom-input-row input {
      flex: 1;
      padding: 5px 6px;
      font-size: 0.76rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-family: inherit;
    }

    .soft-input-row button,
    .custom-input-row button {
      padding: 5px 8px;
      font-size: 0.74rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #eef2ff;
      cursor: pointer;
      white-space: nowrap;
      color: #1d4ed8;
      font-weight: 500;
      transition: background 0.12s ease, transform 0.05s ease, box-shadow 0.1s ease;
    }

    .soft-input-row button:hover,
    .custom-input-row button:hover {
      background: #e0e7ff;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.1);
    }

    .soft-input-row button:active,
    .custom-input-row button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .custom-label {
      font-size: 0.72rem;
      color: #6b7280;
      margin-top: 3px;
    }

    @media (max-width: 400px) {
      .table-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>舍廊(サラン) 주문 관리</h1>
  <div class="subtitle">
    테이블 선택 → 메뉴 입력 → 테이블별 합계 / 飲み放題 시간 관리.<br>
    브라우저를 새로고침해도 데이터가 유지됩니다.
  </div>

  <div class="top-row">
    <!-- 테이블 선택 -->
    <div class="panel">
      <div class="panel-title">테이블 선택 / 카운터 관리</div>
      <div class="table-list" id="tableList"></div>
      <button class="small-btn" onclick="addCounterGroup()">카운터 그룹 추가</button>
    </div>

    <!-- 합계 / 飲み放題 -->
    <div class="panel">
      <div class="panel-title">현재 테이블 / 합계</div>
      <div class="current-table-name" id="currentTableName">선택된 테이블 없음</div>
      <div class="total-amount" id="totalAmount">합계: 0 円</div>
      <button class="reset-btn" onclick="resetCurrentTable()">현재 테이블 주문 초기화</button>

      <div class="summary-list" id="summaryList">
        <!-- 주문 요약 -->
      </div>

      <div class="nomihodai-info" id="nomihodaiInfo" style="display:none;">
        <div><strong>飲み放題(2시간) 정보</strong></div>
        <div id="nomihodaiTimes"></div>
        <textarea
          id="nomihodaiMemo"
          class="nomihodai-memo"
          placeholder="손님이 주문한 주류/음료를 메모하세요."
          oninput="updateNomihodaiMemo(this.value)"
        ></textarea>
      </div>
    </div>
  </div>

  <!-- 메뉴 -->
  <div class="menu-panel">
    <div class="menu-header">
      <div class="menu-header-title">메뉴</div>
      <div class="menu-note">카테고리 제목을 눌러 펼치기 / 접기</div>
    </div>
    <div id="menuContainer"></div>
  </div>
</div>

<script>
  /*************************************************************
   * 메뉴 데이터
   *************************************************************/
  const menuData = {
    "お通し": [
      { id: "otoshi", name: "お通し(お一人様)", price: 200 }
    ],
    "많이 주문하는 메뉴": [
      { id: "nama-beer", name: "生ビール", price: 660 },
      { id: "seafood-jeon", name: "해물전（海鮮チヂミ)", price: 1430 },
      { id: "cheese-tteokbokki", name: "치즈 떡볶이（チーズトッポッキ)", price: 1210 },
      { id: "kimbap", name: "김밥（キンパブ)", price: 1210 },
      { id: "soondubu-seafood", name: "해물순두부（スンドゥブ 海鮮)", price: 1320 },
      { id: "japchae", name: "잡채（チャプチェ)", price: 1320 }
    ],
    "주류（お酒）": [
      { id: "nomihodai", name: "飲み放題(2時間)", price: 2530, isNomihodai: true },
      { id: "nama-beer", name: "生ビール", price: 660 },
      { id: "soju", name: "소주（韓国焼酎）", price: 1320 },
      { id: "bottle-beer", name: "병맥주（瓶ビール）", price: 770 },
      { id: "non-al-beer", name: "논알콜맥주（ノンアルコールビール）", price: 660 }
    ],
    "막걸리류（マッコリ）": [
      { id: "mak-soda", name: "막걸리 사이다（マッコリ　サイダ）", price: 610 },
      { id: "mak-glass", name: "막걸리 글라스（マッコリ　グラス）", price: 610 },
      { id: "nam-mak", name: "생막걸리（生マッコリ）", price: 1870 },
      { id: "edon-mak", name: "이동막걸리（EDon マッコリ）", price: 1980 },
      { id: "mak-honey", name: "꿀추가（蜂蜜追加）", price: 110 }
    ],
    "기타 주류（他のお酒）": [
      { id: "chu-hi-highball", name: "츄하이/하이볼（チューハイ/ハイボール）", price: 550 },
      { id: "umeshu-sake", name: "우메슈/니혼슈（梅酒/日本酒）", price: 550 },
      { id: "insam-ju", name: "고려인삼주（高麗人参酒）", price: 660 }
    ],
    "소프트드링크（ソフトドリンク）": [
      { id: "soft-all", name: "전메뉴（全メニュー）", price: 440, type: "soft" }
    ],
    "안주류（おつまみ）": [
      { id: "lettuce-salad", name: "상추 샐러드（チシャサラダ)", price: 770 },
      { id: "kimchi-mori", name: "김치모듬（キムチ盛り合わせ)", price: 1100 },
      { id: "namul-mori", name: "나물모듬（ナムル盛り合わせ)", price: 880 },
      { id: "japchae", name: "잡채（チャプチェ)", price: 1320 },
      { id: "gyeran-jjim", name: "계란찜（ケランチム)", price: 880 },
      { id: "ojingeo-bok", name: "오징어볶음（イカ炒め)", price: 1430 }
    ],
    "찌개류（鍋、チゲ）": [
      { id: "oden-nabe", name: "오뎅탕（おでん鍋)", price: 1320 },
      { id: "kalguksu", name: "칼국수（カルグクス)", price: 1210 },
      { id: "doenjang-jjige", name: "된장찌개（味噌チゲ)", price: 1320 },
      { id: "tuna-kimchi-jjige", name: "참치 김치찌개（ツナキムチチゲ)", price: 1430 },
      { id: "kimchi-jjige", name: "김치찌개（キムチチゲ)", price: 1540 },
      { id: "soondubu-seafood", name: "해물 순두부（スンドゥブ 海鮮)", price: 1320 },
      { id: "soondubu-pork", name: "돼지고기 순두부（スンドゥブ 豚)", price: 1320 },
      { id: "seolleongtang", name: "설렁탕（ソルロンタン)", price: 1430 },
      { id: "beef-gukbap", name: "소고기국밥（ソゴギクッパ)", price: 1320 },
      { id: "dak-bokkeum-tang", name: "닭볶음탕（鳥炒め)", price: 1430 },
      { id: "gamjatang", name: "감자탕（カムジャタン)", price: 1980 },
      { id: "samgyetang", name: "삼계탕（サムゲタン)", price: 2750 }
    ],
    "비빔밥류（ビビンバ）": [
      { id: "vege-bibimbap", name: "야채비빔밥（野菜ビビンバ)", price: 1210 },
      { id: "dolsot-bibimbap", name: "돌솥비빔밥（石焼ビビンバ)", price: 1210 },
      { id: "ojingeo-dolsot", name: "오징어 돌솥비빔밥（イカ石焼ビビンバ)", price: 1430 },
      { id: "rice", name: "공기밥（ご飯)", price: 250 }
    ],
    "면류（麺）": [
      { id: "naengmyeon", name: "냉면（冷麺)", price: 1100 },
      { id: "bibim-guksu", name: "비빔국수（ビビン素麺)", price: 1210 }
    ],
    "김밥류（キンパブ）": [
      { id: "kimbap", name: "김밥（キンパブ)", price: 1210 },
      { id: "bulgogi-kimbap", name: "불고기김밥（プルゴギキンパブ)", price: 1320 },
      { id: "changja-roll", name: "창자김밥（チャンジャ巻き)", price: 1210 },
      { id: "spicy-cheese-kimbap", name: "매운치즈김밥（辛いチーズキンパブ)", price: 1320 }
    ],
    "전류（チヂミ）": [
      { id: "seafood-jeon", name: "해물전（海鮮チヂミ)", price: 1430 },
      { id: "kimchi-jeon", name: "김치전（キムチチヂミ)", price: 1320 },
      { id: "kimchi-cheese-jeon", name: "김치 치즈전（キムチチーズチヂミ)", price: 1430 },
      { id: "potato-jeon", name: "감자전（ジャガイモチヂミ)", price: 880 },
      { id: "haemul-pajeon", name: "해물파전（へムルパジョン)", price: 1650 }
    ],
    "고기류(삼겹살）": [
      { id: "samgyeopsal-dx", name: "삼겹살 디럭스코스(2인 이상)（サムギョップサルDXコース)", price: 4400 },
      { id: "samgyeopsal-a", name: "삼겹살 A코스(2인 이상)（サムギョップサルAコース)", price: 2970 },
      { id: "samgyeopsal", name: "삼겹살(2인 이상)（サムギョップサル)", price: 1650 },
      { id: "meat-add", name: "고기추가（お肉追加)", price: 880 },
      { id: "sangchu-set", name: "상추/마늘/청양고추 추가（サンチュ・ニンニク・青唐辛子)", price: 330 }
    ],
    "고기류(닭고기）": [
      { id: "cheese-dakgalbi", name: "치즈 닭갈비（チーズタッカルビ)", price: 1540 },
      { id: "cheese-add", name: "치즈 추가（チーズ追加)", price: 330 },
      { id: "dakgangjeong", name: "닭강정（タッカンジョン)", price: 1650 }
    ],
    "고기류(기타）": [
      { id: "la-galbi", name: "LA갈비（LAカルビ)", price: 2200 },
      { id: "jokbal", name: "족발（豚足)", price: 2200 },
      { id: "jeyuk-bok", name: "제육볶음（辛い豚肉炒め)", price: 1320 },
      { id: "osam-bulgogi", name: "오삼불고기（イカ炒めサムギョップサル)", price: 1650 },
      { id: "soondae", name: "순대（スンデ)", price: 1320 },
      { id: "bulgogi", name: "불고기（プルゴギ)", price: 1430 }
    ],
    "떡볶이류（トッポッキ）": [
      { id: "tteokbokki", name: "떡볶이（トッポッキ)", price: 1100 },
      { id: "cheese-tteokbokki", name: "치즈 떡볶이（チーズトッポッキ)", price: 1210 },
      { id: "rabokki", name: "라볶이（ラポッキ)", price: 1210 },
      { id: "cheese-rabokki", name: "치즈 라볶이（チーズラポッキ)", price: 1320 },
      { id: "oil-tteokbokki", name: "기름 떡볶이（キルムトッポッキ)", price: 990 },
      { id: "bulgogi-tteokbokki", name: "불고기 떡볶이（プルゴギトッポッキ)", price: 1320 }
    ]
  };

  /*************************************************************
   * 상태 & 저장
   *************************************************************/
  const STORAGE_KEY = "sarangOrderStateV1";

  const itemsIndex = {};
  let tablesState = {};
  let currentTableId = null;
  let counterIndex = 1;

  function initDefaultTables() {
    // 기본 테이블: 1F/2F 먼저, 카운터는 맨 끝에 하나
    tablesState = {
      "1f-table-1": {
        displayName: "1F 테이블 1번",
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      },
      "1f-table-2": {
        displayName: "1F 테이블 2번",
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      },
      "2f-table-1": {
        displayName: "2F 테이블 1번",
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      },
      "2f-table-2": {
        displayName: "2F 테이블 2번",
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      },
      "1f-counter-1": {
        displayName: "1F 카운터석 #1",
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      }
    };
    currentTableId = "1f-table-1";
    counterIndex = 1;
  }

  function saveAppState() {
    try {
      const plainTables = {};
      Object.entries(tablesState).forEach(([id, t]) => {
        const ordersCopy = {};
        Object.entries(t.orders).forEach(([k, o]) => {
          ordersCopy[k] = { ...o };
        });
        plainTables[id] = {
          displayName: t.displayName,
          orders: ordersCopy,
          nomihodaiStart: t.nomihodaiStart ? t.nomihodaiStart.toISOString() : null,
          nomihodaiMemo: t.nomihodaiMemo || ""
        };
      });
      const data = {
        tablesState: plainTables,
        currentTableId,
        counterIndex
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {}
  }

  function loadAppState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        initDefaultTables();
        return;
      }
      const data = JSON.parse(raw);
      if (!data || !data.tablesState) {
        initDefaultTables();
        return;
      }
      tablesState = {};
      Object.entries(data.tablesState).forEach(([id, t]) => {
        const ordersCopy = {};
        Object.entries(t.orders || {}).forEach(([k, o]) => {
          ordersCopy[k] = { ...o };
        });
        tablesState[id] = {
          displayName: t.displayName || id,
          orders: ordersCopy,
          nomihodaiStart: t.nomihodaiStart ? new Date(t.nomihodaiStart) : null,
          nomihodaiMemo: t.nomihodaiMemo || ""
        };
      });
      currentTableId = data.currentTableId && tablesState[data.currentTableId]
        ? data.currentTableId
        : Object.keys(tablesState)[0];
      counterIndex = data.counterIndex || 1;
    } catch (e) {
      initDefaultTables();
    }
  }

  /*************************************************************
   * 초기화
   *************************************************************/
  function init() {
    initMenu();
    loadAppState();
    renderTables();
    updateCurrentTableView();
  }

  /*************************************************************
   * 테이블 관리
   *************************************************************/
  function renderTables() {
    const tableList = document.getElementById("tableList");
    tableList.innerHTML = "";

    // 1F/2F 테이블 먼저, 그다음 카운터석
    const entries = Object.entries(tablesState);
    const normal = [];
    const counters = [];

    entries.forEach(([id, t]) => {
      if (id.includes("counter")) counters.push([id, t]);
      else normal.push([id, t]);
    });

    const ordered = normal.concat(counters);

    ordered.forEach(([id, t]) => {
      const btn = document.createElement("button");
      btn.className = "table-btn" + (id === currentTableId ? " active" : "");

      const label = document.createElement("span");
      label.textContent = t.displayName;
      btn.appendChild(label);

      // 카운터석은 X 삭제 버튼 추가
      if (id.includes("counter")) {
        const close = document.createElement("span");
        close.className = "table-close";
        close.textContent = "×";
        close.onclick = (e) => {
          e.stopPropagation();
          deleteCounterTable(id);
        };
        btn.appendChild(close);
      }

      btn.onclick = () => selectTable(id);
      tableList.appendChild(btn);
    });
  }

  function selectTable(id) {
    if (!tablesState[id]) return;
    currentTableId = id;
    renderTables();
    updateCurrentTableView();
    saveAppState();
  }

  function addCounterGroup() {
    counterIndex++;
    const id = `1f-counter-${counterIndex}`;
    tablesState[id] = {
      displayName: `1F 카운터석 #${counterIndex}`,
      orders: {},
      nomihodaiStart: null,
      nomihodaiMemo: ""
    };
    renderTables();
    saveAppState();
  }

  function deleteCounterTable(id) {
    if (!id.includes("counter")) return;
    const table = tablesState[id];
    if (!table) return;

    if (Object.keys(tablesState).length <= 1) {
      alert("마지막 테이블은 삭제할 수 없습니다.");
      return;
    }

    if (Object.keys(table.orders || {}).length > 0) {
      const ok = confirm("이 카운터석의 주문이 모두 삭제됩니다. 계속하시겠습니까?");
      if (!ok) return;
    }

    delete tablesState[id];

    if (currentTableId === id) {
      const remainingIds = Object.keys(tablesState);
      currentTableId = remainingIds.length > 0 ? remainingIds[0] : null;
    }

    renderTables();
    updateCurrentTableView();
    saveAppState();
  }

  function getCurrentTableState() {
    if (!currentTableId || !tablesState[currentTableId]) return null;
    return tablesState[currentTableId];
  }

  /*************************************************************
   * 메뉴 UI 생성
   *************************************************************/
  function initMenu() {
    const menuContainer = document.getElementById("menuContainer");
    menuContainer.innerHTML = "";

    Object.entries(menuData).forEach(([categoryName, items]) => {
      const categoryDiv = document.createElement("div");
      categoryDiv.className = "category";

      const headerBtn = document.createElement("button");
      headerBtn.className = "category-header";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = categoryName;
      const arrowSpan = document.createElement("span");
      arrowSpan.textContent = "＋";

      headerBtn.appendChild(titleSpan);
      headerBtn.appendChild(arrowSpan);

      const bodyDiv = document.createElement("div");
      bodyDiv.className = "category-body";

      headerBtn.onclick = () => toggleCategoryBody(bodyDiv, arrowSpan);

      items.forEach(item => {
        if (!itemsIndex[item.id]) {
          itemsIndex[item.id] = { ...item, category: categoryName };
        }

        if (item.type === "soft") {
          const row = document.createElement("div");
          row.className = "menu-item soft-row";

          const left = document.createElement("div");
          left.className = "menu-left";

          const n = document.createElement("div");
          n.className = "menu-name";
          n.textContent = item.name;

          const p = document.createElement("div");
          p.className = "menu-price";
          p.textContent = `${item.price.toLocaleString()} 円 (메뉴명 직접 입력)`;

          left.appendChild(n);
          left.appendChild(p);

          const softRow = document.createElement("div");
          softRow.className = "soft-input-row";

          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "예) 콜라, 사이다, 오렌지주스";

          const btn = document.createElement("button");
          btn.textContent = "추가";
          btn.onclick = () => addSoftDrink(item.id, input);

          softRow.appendChild(input);
          softRow.appendChild(btn);

          row.appendChild(left);
          row.appendChild(softRow);
          bodyDiv.appendChild(row);
        } else {
          const row = document.createElement("div");
          row.className = "menu-item";

          const left = document.createElement("div");
          left.className = "menu-left";

          const n = document.createElement("div");
          n.className = "menu-name";
          n.textContent = item.name;

          const p = document.createElement("div");
          p.className = "menu-price";
          p.textContent = `${item.price.toLocaleString()} 円`;

          left.appendChild(n);
          left.appendChild(p);

          const right = document.createElement("div");
          right.className = "menu-right";

          const minusBtn = document.createElement("button");
          minusBtn.className = "qty-btn";
          minusBtn.textContent = "-";
          minusBtn.onclick = () => changeNormalItemQuantity(item.id, -1);

          const qtySpan = document.createElement("span");
          qtySpan.className = "qty-display";
          qtySpan.dataset.qtyFor = item.id;
          qtySpan.textContent = "0";

          const plusBtn = document.createElement("button");
          plusBtn.className = "qty-btn";
          plusBtn.textContent = "+";
          plusBtn.onclick = () => changeNormalItemQuantity(item.id, +1);

          right.appendChild(minusBtn);
          right.appendChild(qtySpan);
          right.appendChild(plusBtn);

          row.appendChild(left);
          row.appendChild(right);
          bodyDiv.appendChild(row);
        }
      });

      // 카테고리별 임의 금액 입력 줄
      const customRow = document.createElement("div");
      customRow.className = "menu-item soft-row";

      const leftCustom = document.createElement("div");
      leftCustom.className = "menu-left";

      const clabel = document.createElement("div");
      clabel.className = "custom-label";
      clabel.textContent = "메뉴에 없는 금액 / 설명 추가";

      leftCustom.appendChild(clabel);

      const customInputRow = document.createElement("div");
      customInputRow.className = "custom-input-row";

      const descInput = document.createElement("input");
      descInput.type = "text";
      descInput.placeholder = "설명 (예: 서비스, 추가요금 등)";

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "금액 (円)";
      amountInput.inputMode = "numeric";

      const addBtn = document.createElement("button");
      addBtn.textContent = "추가";
      addBtn.onclick = () => addCustomItem(categoryName, descInput, amountInput);

      customInputRow.appendChild(descInput);
      customInputRow.appendChild(amountInput);
      customInputRow.appendChild(addBtn);

      customRow.appendChild(leftCustom);
      customRow.appendChild(customInputRow);
      bodyDiv.appendChild(customRow);

      categoryDiv.appendChild(headerBtn);
      categoryDiv.appendChild(bodyDiv);
      menuContainer.appendChild(categoryDiv);
    });
  }

  function toggleCategoryBody(bodyDiv, arrowSpan) {
    const isOpen = bodyDiv.classList.contains("open");
    if (isOpen) {
      bodyDiv.classList.remove("open");
      arrowSpan.textContent = "＋";
    } else {
      bodyDiv.classList.add("open");
      arrowSpan.textContent = "－";
    }
  }

  /*************************************************************
   * 주문 조작: 일반 메뉴
   *************************************************************/
  function changeNormalItemQuantity(itemId, delta) {
    const table = getCurrentTableState();
    if (!table) return;
    const item = itemsIndex[itemId];
    if (!item) return;

    const orderKey = itemId;
    const existing = table.orders[orderKey] || {
      itemId,
      name: item.name,
      price: item.price,
      qty: 0
    };

    let newQty = existing.qty + delta;
    if (newQty < 0) newQty = 0;
    existing.qty = newQty;

    if (newQty === 0) {
      delete table.orders[orderKey];
    } else {
      table.orders[orderKey] = existing;
    }

    if (item.isNomihodai) {
      if (existing.qty > 0 && !table.nomihodaiStart) {
        table.nomihodaiStart = new Date();
      }
      if (existing.qty === 0) {
        table.nomihodaiStart = null;
        table.nomihodaiMemo = "";
      }
    }

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 주문 조작: 소프트드링크 전메뉴
   *************************************************************/
  function addSoftDrink(itemId, inputEl) {
    const table = getCurrentTableState();
    if (!table) return;
    const item = itemsIndex[itemId];
    if (!item) return;
    const label = (inputEl.value || "").trim();
    if (!label) {
      alert("소프트드링크 메뉴명을 입력해주세요.");
      return;
    }

    const orderKey = `${itemId}::${label}`;
    const displayName = `${item.name} - ${label}`;

    const existing = table.orders[orderKey] || {
      itemId,
      name: displayName,
      price: item.price,
      qty: 0,
      softName: label
    };
    existing.qty += 1;
    table.orders[orderKey] = existing;

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 주문 조작: 임의 금액
   *************************************************************/
  function addCustomItem(categoryName, descInput, amountInput) {
    const table = getCurrentTableState();
    if (!table) return;

    const desc = (descInput.value || "").trim();
    const amount = parseInt(amountInput.value, 10);

    if (!amount || amount <= 0) {
      alert("유효한 금액(円)을 입력해주세요.");
      return;
    }

    const label = desc ? desc : `${categoryName} 임의 항목`;
    const orderKey = `custom::${Date.now()}::${Math.random().toString(36).slice(2,7)}`;

    table.orders[orderKey] = {
      itemId: "custom",
      name: `【임의】${label}`,
      price: amount,
      qty: 1,
      category: categoryName
    };

    descInput.value = "";
    amountInput.value = "";

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 화면 갱신 / 합계 / 飲み放題
   *************************************************************/
  function updateCurrentTableView() {
    const table = getCurrentTableState();
    const currentTableName = document.getElementById("currentTableName");
    const totalAmountEl = document.getElementById("totalAmount");
    const summaryList = document.getElementById("summaryList");
    const nomihodaiInfo = document.getElementById("nomihodaiInfo");
    const nomihodaiTimes = document.getElementById("nomihodaiTimes");
    const nomihodaiMemo = document.getElementById("nomihodaiMemo");

    document.querySelectorAll("[data-qty-for]").forEach(span => {
      span.textContent = "0";
    });

    if (!table) {
      currentTableName.textContent = "선택된 테이블 없음";
      totalAmountEl.textContent = "합계: 0 円";
      summaryList.innerHTML = "";
      nomihodaiInfo.style.display = "none";
      return;
    }

    currentTableName.textContent = `현재 테이블: ${table.displayName}`;

    let total = 0;
    summaryList.innerHTML = "";

    Object.entries(table.orders).forEach(([orderKey, order]) => {
      const lineTotal = order.price * order.qty;
      total += lineTotal;

      if (!order.softName && order.itemId !== "custom") {
        document.querySelectorAll(`[data-qty-for="${order.itemId}"]`)
          .forEach(span => span.textContent = String(order.qty));
      }

      const row = document.createElement("div");
      row.className = "summary-item";

      const nameSpan = document.createElement("span");
      nameSpan.className = "summary-name";
      nameSpan.textContent = order.name;

      const infoSpan = document.createElement("span");
      infoSpan.className = "summary-info";
      infoSpan.textContent = `${order.qty}개 = ${lineTotal.toLocaleString()} 円`;

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "삭제";
      delBtn.onclick = () => deleteOrder(orderKey);

      row.appendChild(nameSpan);
      row.appendChild(infoSpan);
      row.appendChild(delBtn);
      summaryList.appendChild(row);
    });

    totalAmountEl.textContent = `합계: ${total.toLocaleString()} 円`;

    if (table.nomihodaiStart) {
      nomihodaiInfo.style.display = "block";
      const start = table.nomihodaiStart;
      const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);
      nomihodaiTimes.textContent =
        `시작: ${formatTime(start)}  /  종료 예정: ${formatTime(end)}`;
      nomihodaiMemo.value = table.nomihodaiMemo || "";
    } else {
      nomihodaiInfo.style.display = "none";
      nomihodaiMemo.value = "";
    }
  }

  function deleteOrder(orderKey) {
    const table = getCurrentTableState();
    if (!table) return;
    const order = table.orders[orderKey];
    if (!order) return;

    const item = itemsIndex[order.itemId];
    if (item && item.isNomihodai) {
      table.nomihodaiStart = null;
      table.nomihodaiMemo = "";
    }

    delete table.orders[orderKey];
    updateCurrentTableView();
    saveAppState();
  }

  function resetCurrentTable() {
    const table = getCurrentTableState();
    if (!table) return;
    table.orders = {};
    table.nomihodaiStart = null;
    table.nomihodaiMemo = "";
    updateCurrentTableView();
    saveAppState();
  }

  function updateNomihodaiMemo(value) {
    const table = getCurrentTableState();
    if (!table) return;
    table.nomihodaiMemo = value;
    saveAppState();
  }

  function formatTime(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const hh = String(date.getHours()).padStart(2, "0");
    const mm = String(date.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }

  /*************************************************************
   * 확대/축소 방지용 이벤트
   *************************************************************/
  // 더블탭 확대 방지
  document.addEventListener('dblclick', function (e) {
    e.preventDefault();
  }, { passive: false });

  // iOS Safari 제스처 확대 방지
  window.addEventListener('gesturestart', function (e) {
    e.preventDefault();
  }, { passive: false });

  window.onload = init;
</script>
</body>
</html>
