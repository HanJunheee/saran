<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>舍廊(サラン) 주문 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 8px;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
      "Noto Sans KR", sans-serif;
      background: #f2f2f2;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 540px;
      background: #ffffff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 1.3rem;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fafafa;
    }

    .panel-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* 테이블 선택 */
    .table-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .table-btn {
      padding: 7px 6px;
      font-size: 0.8rem;
      border-radius: 16px;
      border: 1px solid #ccc;
      background: #ffffff;
      cursor: pointer;
      text-align: center;
    }

    .table-btn.active {
      background: #d84343;
      color: #ffffff;
      border-color: #d84343;
    }

    .small-btn {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 14px;
      border: 1px solid #888;
      background: #fff;
      cursor: pointer;
    }

    /* 합계 / 飲み放題 */
    .current-table-name {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .total-amount {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .summary-list {
      max-height: 210px;
      overflow-y: auto;
      margin-top: 4px;
      padding-right: 2px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      padding: 2px 0;
      border-bottom: 1px solid #eee;
    }

    .summary-name {
      max-width: 58%;
    }

    .summary-info {
      white-space: nowrap;
      margin-left: 4px;
    }

    .delete-btn {
      margin-left: 4px;
      padding: 2px 6px;
      font-size: 0.7rem;
      border-radius: 10px;
      border: 1px solid #c00;
      background: #fff0f0;
      color: #c00;
      cursor: pointer;
    }

    .reset-btn {
      margin-top: 4px;
      padding: 5px 8px;
      font-size: 0.8rem;
      border-radius: 14px;
      border: 1px solid #777;
      background: #ffffff;
      cursor: pointer;
    }

    .nomihodai-info {
      margin-top: 6px;
      padding: 6px;
      background: #fff8e1;
      border-radius: 6px;
      border: 1px solid #f0d27a;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .nomihodai-memo {
      width: 100%;
      margin-top: 4px;
      font-size: 0.75rem;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      resize: vertical;
      min-height: 40px;
    }

    /* 메뉴 패널 */
    .menu-panel {
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 8px;
      background: #ffffff;
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .menu-header-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .menu-note {
      font-size: 0.72rem;
      color: #777;
    }

    .category {
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      margin-bottom: 6px;
      overflow: hidden;
      background: #fff;
    }

    .category-header {
      width: 100%;
      text-align: left;
      padding: 6px 8px;
      background: #f5f5f5;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-header span {
      pointer-events: none;
    }

    .category-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-top: 1px solid #eee;
    }

    .category-body.open {
      max-height: 1200px; /* 넉넉하게 */
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.78rem;
    }

    .menu-left {
      display: flex;
      flex-direction: column;
    }

    .menu-name {
      font-weight: 500;
    }

    .menu-price {
      color: #777;
      font-size: 0.72rem;
    }

    .menu-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .qty-display {
      min-width: 20px;
      text-align: center;
      font-size: 0.78rem;
    }

    .qty-btn {
      width: 26px;
      height: 26px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    .soft-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .soft-input-row,
    .custom-input-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      width: 100%;
    }

    .soft-input-row input,
    .custom-input-row input {
      flex: 1;
      padding: 4px;
      font-size: 0.76rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .soft-input-row button,
    .custom-input-row button {
      padding: 4px 8px;
      font-size: 0.74rem;
      border-radius: 4px;
      border: 1px solid #888;
      background: #eee;
      cursor: pointer;
      white-space: nowrap;
    }

    .custom-label {
      font-size: 0.72rem;
      color: #555;
      margin-top: 3px;
    }

  </style>
</head>
<body>
<div class="app">
  <h1>舍廊(サラン) 주문 관리</h1>
  <div class="subtitle">
    테이블 선택 → 메뉴 입력 → 테이블별 합계 / 飲み放題 시간 관리.<br>
    새로고침해도 데이터가 유지됩니다.
  </div>

  <div class="top-row">
    <!-- 테이블 선택 -->
    <div class="panel">
      <div class="panel-title">테이블 선택 / 카운터 관리</div>
      <div class="table-list" id="tableList"></div>
      <button class="small-btn" onclick="addCounterGroup()">카운터 그룹 추가</button>
    </div>

    <!-- 합계 / 飲み放題 -->
    <div class="panel">
      <div class="panel-title">현재 테이블 / 합계</div>
      <div class="current-table-name" id="currentTableName">선택된 테이블 없음</div>
      <div class="total-amount" id="totalAmount">합계: 0 円</div>
      <button class="reset-btn" onclick="resetCurrentTable()">현재 테이블 주문 초기화</button>

      <div class="summary-list" id="summaryList">
        <!-- 주문 요약 -->
      </div>

      <div class="nomihodai-info" id="nomihodaiInfo" style="display:none;">
        <div><strong>飲み放題(2시간) 정보</strong></div>
        <div id="nomihodaiTimes"></div>
        <textarea
          id="nomihodaiMemo"
          class="nomihodai-memo"
          placeholder="손님이 주문한 주류/음료를 메모하세요."
          oninput="updateNomihodaiMemo(this.value)"
        ></textarea>
      </div>
    </div>
  </div>

  <!-- 메뉴 -->
  <div class="menu-panel">
    <div class="menu-header">
      <div class="menu-header-title">메뉴</div>
      <div class="menu-note">카테고리 제목을 눌러 펼치기 / 접기</div>
    </div>
    <div id="menuContainer"></div>
  </div>
</div>

<script>
  /*************************************************************
   * 메뉴 데이터
   *************************************************************/
  const menuData = {
    "お通し": [
      { id: "otoshi", name: "お通し(お一人様)", price: 200 }
    ],
    "많이 주문하는 메뉴": [
      { id: "nama-beer", name: "生ビール", price: 660 },
      { id: "seafood-jeon", name: "해물전（海鮮チヂミ)", price: 1430 },
      { id: "cheese-tteokbokki", name: "치즈 떡볶이（チーズトッポッキ)", price: 1210 },
      { id: "kimbap", name: "김밥（キンパブ)", price: 1210 },
      { id: "soondubu-seafood", name: "해물순두부（スンドゥブ 海鮮)", price: 1320 },
      { id: "japchae", name: "잡채（チャプチェ)", price: 1320 }
    ],
    "주류（お酒）": [
      { id: "nomihodai", name: "飲み放題(2時間)", price: 2530, isNomihodai: true },
      { id: "nama-beer", name: "生ビール", price: 660 },
      { id: "soju", name: "소주（韓国焼酎）", price: 1320 },
      { id: "bottle-beer", name: "병맥주（瓶ビール）", price: 770 },
      { id: "non-al-beer", name: "논알콜맥주（ノンアルコールビール）", price: 660 }
    ],
    "막걸리류（マッコリ）": [
      { id: "mak-soda", name: "막걸리 사이다（マッコリ　サイダ）", price: 610 },
      { id: "mak-glass", name: "막걸리 글라스（マッコリ　グラス）", price: 610 },
      { id: "nam-mak", name: "생막걸리（生マッコリ）", price: 1870 },
      { id: "edon-mak", name: "이동막걸리（EDon マッコリ）", price: 1980 },
      { id: "mak-honey", name: "꿀추가（蜂蜜追加）", price: 110 }
    ],
    "기타 주류（他のお酒）": [
      { id: "chu-hi-highball", name: "츄하이/하이볼（チューハイ/ハイボール）", price: 550 },
      { id: "umeshu-sake", name: "우메슈/니혼슈（梅酒/日本酒）", price: 550 },
      { id: "insam-ju", name: "고려인삼주（高麗人参酒）", price: 660 }
    ],
    "소프트드링크（ソフトドリンク）": [
      { id: "soft-all", name: "전메뉴（全メニュー）", price: 440, type: "soft" }
    ],
    "안주류（おつまみ）": [
      { id: "lettuce-salad", name: "상추 샐러드（チシャサラダ)", price: 770 },
      { id: "kimchi-mori", name: "김치모듬（キムチ盛り合わせ)", price: 1100 },
      { id: "namul-mori", name: "나물모듬（ナムル盛り合わせ)", price: 880 },
      { id: "japchae", name: "잡채（チャプチェ)", price: 1320 },
      { id: "gyeran-jjim", name: "계란찜（ケランチム)", price: 880 },
      { id: "ojingeo-bok", name: "오징어볶음（イカ炒め)", price: 1430 }
    ],
    "찌개류（鍋、チゲ）": [
      { id: "oden-nabe", name: "오뎅탕（おでん鍋)", price: 1320 },
      { id: "kalguksu", name: "칼국수（カルグクス)", price: 1210 },
      { id: "doenjang-jjige", name: "된장찌개（味噌チゲ)", price: 1320 },
      { id: "tuna-kimchi-jjige", name: "참치 김치찌개（ツナキムチチゲ)", price: 1430 },
      { id: "kimchi-jjige", name: "김치찌개（キムチチゲ)", price: 1540 },
      { id: "soondubu-seafood", name: "해물 순두부（スンドゥブ 海鮮)", price: 1320 },
      { id: "soondubu-pork", name: "돼지고기 순두부（スンドゥブ 豚)", price: 1320 },
      { id: "seolleongtang", name: "설렁탕（ソルロンタン)", price: 1430 },
      { id: "beef-gukbap", name: "소고기국밥（ソゴギクッパ)", price: 1320 },
      { id: "dak-bokkeum-tang", name: "닭볶음탕（鳥炒め)", price: 1430 },
      { id: "gamjatang", name: "감자탕（カムジャタン)", price: 1980 },
      { id: "samgyetang", name: "삼계탕（サムゲタン)", price: 2750 }
    ],
    "비빔밥류（ビビンバ）": [
      { id: "vege-bibimbap", name: "야채비빔밥（野菜ビビンバ)", price: 1210 },
      { id: "dolsot-bibimbap", name: "돌솥비빔밥（石焼ビビンバ)", price: 1210 },
      { id: "ojingeo-dolsot", name: "오징어 돌솥비빔밥（イカ石焼ビビンバ)", price: 1430 },
      { id: "rice", name: "공기밥（ご飯)", price: 250 }
    ],
    "면류（麺）": [
      { id: "naengmyeon", name: "냉면（冷麺)", price: 1100 },
      { id: "bibim-guksu", name: "비빔국수（ビビン素麺)", price: 1210 }
    ],
    "김밥류（キンパブ）": [
      { id: "kimbap", name: "김밥（キンパブ)", price: 1210 },
      { id: "bulgogi-kimbap", name: "불고기김밥（プルゴギキンパブ)", price: 1320 },
      { id: "changja-roll", name: "창자김밥（チャンジャ巻き)", price: 1210 },
      { id: "spicy-cheese-kimbap", name: "매운치즈김밥（辛いチーズキンパブ)", price: 1320 }
    ],
    "전류（チヂミ）": [
      { id: "seafood-jeon", name: "해물전（海鮮チヂミ)", price: 1430 },
      { id: "kimchi-jeon", name: "김치전（キムチチヂミ)", price: 1320 },
      { id: "kimchi-cheese-jeon", name: "김치 치즈전（キムチチーズチヂミ)", price: 1430 },
      { id: "potato-jeon", name: "감자전（ジャガイモチヂミ)", price: 880 },
      { id: "haemul-pajeon", name: "해물파전（へムルパジョン)", price: 1650 }
    ],
    "고기류(삼겹살）": [
      { id: "samgyeopsal-dx", name: "삼겹살 디럭스코스(2인 이상)（サムギョップサルDXコース)", price: 4400 },
      { id: "samgyeopsal-a", name: "삼겹살 A코스(2인 이상)（サムギョップサルAコース)", price: 2970 },
      { id: "samgyeopsal", name: "삼겹살(2인 이상)（サムギョップサル)", price: 1650 },
      { id: "meat-add", name: "고기추가（お肉追加)", price: 880 },
      { id: "sangchu-set", name: "상추/마늘/청양고추 추가（サンチュ・ニンニク・青唐辛子)", price: 330 }
    ],
    "고기류(닭고기）": [
      { id: "cheese-dakgalbi", name: "치즈 닭갈비（チーズタッカルビ)", price: 1540 },
      { id: "cheese-add", name: "치즈 추가（チーズ追加)", price: 330 },
      { id: "dakgangjeong", name: "닭강정（タッカンジョン)", price: 1650 }
    ],
    "고기류(기타）": [
      { id: "la-galbi", name: "LA갈비（LAカルビ)", price: 2200 },
      { id: "jokbal", name: "족발（豚足)", price: 2200 },
      { id: "jeyuk-bok", name: "제육볶음（辛い豚肉炒め)", price: 1320 },
      { id: "osam-bulgogi", name: "오삼불고기（イカ炒めサムギョップサル)", price: 1650 },
      { id: "soondae", name: "순대（スンデ)", price: 1320 },
      { id: "bulgogi", name: "불고기（プルゴギ)", price: 1430 }
    ],
    "떡볶이류（トッポッキ）": [
      { id: "tteokbokki", name: "떡볶이（トッポッキ)", price: 1100 },
      { id: "cheese-tteokbokki", name: "치즈 떡볶이（チーズトッポッキ)", price: 1210 },
      { id: "rabokki", name: "라볶이（ラポッキ)", price: 1210 },
      { id: "cheese-rabokki", name: "치즈 라볶이（チーズラポッキ)", price: 1320 },
      { id: "oil-tteokbokki", name: "기름 떡볶이（キルムトッポッキ)", price: 990 },
      { id: "bulgogi-tteokbokki", name: "불고기 떡볶이（プルゴギトッポッキ)", price: 1320 }
    ]
  };

  /*************************************************************
   * 상태 & 저장
   *************************************************************/
  const STORAGE_KEY = "sarangOrderStateV1";

  const itemsIndex = {}; // itemId -> itemData
  let tablesState = {};  // tableId -> { displayName, orders, nomihodaiStart, nomihodaiMemo }
  let currentTableId = null;
  let counterIndex = 1;

  function initDefaultTables() {
    const baseTables = [
      { id: "1f-counter-1", name: "1F 카운터석 #1" },
      { id: "1f-table-1", name: "1F 테이블 1번" },
      { id: "1f-table-2", name: "1F 테이블 2번" },
      { id: "2f-table-1", name: "2F 테이블 1번" },
      { id: "2f-table-2", name: "2F 테이블 2번" }
    ];
    tablesState = {};
    baseTables.forEach(t => {
      tablesState[t.id] = {
        displayName: t.name,
        orders: {},
        nomihodaiStart: null,
        nomihodaiMemo: ""
      };
    });
    currentTableId = "1f-counter-1";
    counterIndex = 1;
  }

  function saveAppState() {
    try {
      const plainTables = {};
      Object.entries(tablesState).forEach(([id, t]) => {
        const ordersCopy = {};
        Object.entries(t.orders).forEach(([k, o]) => {
          ordersCopy[k] = { ...o };
        });
        plainTables[id] = {
          displayName: t.displayName,
          orders: ordersCopy,
          nomihodaiStart: t.nomihodaiStart ? t.nomihodaiStart.toISOString() : null,
          nomihodaiMemo: t.nomihodaiMemo || ""
        };
      });
      const data = {
        tablesState: plainTables,
        currentTableId,
        counterIndex
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      // 저장 실패는 조용히 무시
    }
  }

  function loadAppState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        initDefaultTables();
        return;
      }
      const data = JSON.parse(raw);
      if (!data || !data.tablesState) {
        initDefaultTables();
        return;
      }
      tablesState = {};
      Object.entries(data.tablesState).forEach(([id, t]) => {
        const ordersCopy = {};
        Object.entries(t.orders || {}).forEach(([k, o]) => {
          ordersCopy[k] = { ...o };
        });
        tablesState[id] = {
          displayName: t.displayName || id,
          orders: ordersCopy,
          nomihodaiStart: t.nomihodaiStart ? new Date(t.nomihodaiStart) : null,
          nomihodaiMemo: t.nomihodaiMemo || ""
        };
      });
      currentTableId = data.currentTableId && tablesState[data.currentTableId]
        ? data.currentTableId
        : Object.keys(tablesState)[0];
      counterIndex = data.counterIndex || 1;
    } catch (e) {
      initDefaultTables();
    }
  }

  /*************************************************************
   * 초기화
   *************************************************************/
  function init() {
    initMenu();       // 메뉴 / itemsIndex
    loadAppState();   // 저장된 테이블 상태 로드 or 기본값
    renderTables();
    updateCurrentTableView();
  }

  /*************************************************************
   * 테이블 관리
   *************************************************************/
  function renderTables() {
    const tableList = document.getElementById("tableList");
    tableList.innerHTML = "";
    Object.entries(tablesState).forEach(([id, t]) => {
      const btn = document.createElement("button");
      btn.className = "table-btn" + (id === currentTableId ? " active" : "");
      btn.textContent = t.displayName;
      btn.onclick = () => selectTable(id);
      tableList.appendChild(btn);
    });
  }

  function selectTable(id) {
    if (!tablesState[id]) return;
    currentTableId = id;
    renderTables();
    updateCurrentTableView();
    saveAppState();
  }

  function addCounterGroup() {
    counterIndex++;
    const id = `1f-counter-${counterIndex}`;
    tablesState[id] = {
      displayName: `1F 카운터석 #${counterIndex}`,
      orders: {},
      nomihodaiStart: null,
      nomihodaiMemo: ""
    };
    renderTables();
    saveAppState();
  }

  function getCurrentTableState() {
    if (!currentTableId || !tablesState[currentTableId]) return null;
    return tablesState[currentTableId];
  }

  /*************************************************************
   * 메뉴 UI 생성
   *************************************************************/
  function initMenu() {
    const menuContainer = document.getElementById("menuContainer");
    menuContainer.innerHTML = "";

    Object.entries(menuData).forEach(([categoryName, items]) => {
      const categoryDiv = document.createElement("div");
      categoryDiv.className = "category";

      const headerBtn = document.createElement("button");
      headerBtn.className = "category-header";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = categoryName;
      const arrowSpan = document.createElement("span");
      arrowSpan.textContent = "＋";

      headerBtn.appendChild(titleSpan);
      headerBtn.appendChild(arrowSpan);

      const bodyDiv = document.createElement("div");
      bodyDiv.className = "category-body";

      headerBtn.onclick = () => toggleCategoryBody(bodyDiv, arrowSpan);

      // 메뉴 아이템 생성
      items.forEach(item => {
        // itemsIndex에 등록 (id 중복 가능하지만 같은 메뉴로 취급)
        if (!itemsIndex[item.id]) {
          itemsIndex[item.id] = { ...item, category: categoryName };
        }

        if (item.type === "soft") {
          // 소프트드링크 전메뉴
          const row = document.createElement("div");
          row.className = "menu-item soft-row";

          const left = document.createElement("div");
          left.className = "menu-left";

          const n = document.createElement("div");
          n.className = "menu-name";
          n.textContent = item.name;

          const p = document.createElement("div");
          p.className = "menu-price";
          p.textContent = `${item.price.toLocaleString()} 円 (메뉴명 직접 입력)`;

          left.appendChild(n);
          left.appendChild(p);

          const softRow = document.createElement("div");
          softRow.className = "soft-input-row";

          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "예) 콜라, 사이다, 오렌지주스";

          const btn = document.createElement("button");
          btn.textContent = "추가";
          btn.onclick = () => addSoftDrink(item.id, input);

          softRow.appendChild(input);
          softRow.appendChild(btn);

          row.appendChild(left);
          row.appendChild(softRow);
          bodyDiv.appendChild(row);
        } else {
          const row = document.createElement("div");
          row.className = "menu-item";

          const left = document.createElement("div");
          left.className = "menu-left";

          const n = document.createElement("div");
          n.className = "menu-name";
          n.textContent = item.name;

          const p = document.createElement("div");
          p.className = "menu-price";
          p.textContent = `${item.price.toLocaleString()} 円`;

          left.appendChild(n);
          left.appendChild(p);

          const right = document.createElement("div");
          right.className = "menu-right";

          const minusBtn = document.createElement("button");
          minusBtn.className = "qty-btn";
          minusBtn.textContent = "-";
          minusBtn.onclick = () => changeNormalItemQuantity(item.id, -1);

          const qtySpan = document.createElement("span");
          qtySpan.className = "qty-display";
          qtySpan.dataset.qtyFor = item.id;
          qtySpan.textContent = "0";

          const plusBtn = document.createElement("button");
          plusBtn.className = "qty-btn";
          plusBtn.textContent = "+";
          plusBtn.onclick = () => changeNormalItemQuantity(item.id, +1);

          right.appendChild(minusBtn);
          right.appendChild(qtySpan);
          right.appendChild(plusBtn);

          row.appendChild(left);
          row.appendChild(right);
          bodyDiv.appendChild(row);
        }
      });

      // 카테고리별 임의 금액 입력 줄
      const customRow = document.createElement("div");
      customRow.className = "menu-item soft-row";

      const leftCustom = document.createElement("div");
      leftCustom.className = "menu-left";

      const clabel = document.createElement("div");
      clabel.className = "custom-label";
      clabel.textContent = "메뉴에 없는 금액 / 설명 추가";

      leftCustom.appendChild(clabel);

      const customInputRow = document.createElement("div");
      customInputRow.className = "custom-input-row";

      const descInput = document.createElement("input");
      descInput.type = "text";
      descInput.placeholder = "설명 (예: 서비스, 추가요금 등)";

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "금액 (円)";
      amountInput.inputMode = "numeric";

      const addBtn = document.createElement("button");
      addBtn.textContent = "추가";
      addBtn.onclick = () => addCustomItem(categoryName, descInput, amountInput);

      customInputRow.appendChild(descInput);
      customInputRow.appendChild(amountInput);
      customInputRow.appendChild(addBtn);

      customRow.appendChild(leftCustom);
      customRow.appendChild(customInputRow);
      bodyDiv.appendChild(customRow);

      categoryDiv.appendChild(headerBtn);
      categoryDiv.appendChild(bodyDiv);
      menuContainer.appendChild(categoryDiv);
    });
  }

  function toggleCategoryBody(bodyDiv, arrowSpan) {
    const isOpen = bodyDiv.classList.contains("open");
    if (isOpen) {
      bodyDiv.classList.remove("open");
      arrowSpan.textContent = "＋";
    } else {
      bodyDiv.classList.add("open");
      arrowSpan.textContent = "－";
    }
  }

  /*************************************************************
   * 주문 조작: 일반 메뉴
   *************************************************************/
  function changeNormalItemQuantity(itemId, delta) {
    const table = getCurrentTableState();
    if (!table) return;
    const item = itemsIndex[itemId];
    if (!item) return;

    const orderKey = itemId; // 일반 메뉴는 itemId 단위로 하나씩 관리
    const existing = table.orders[orderKey] || {
      itemId,
      name: item.name,
      price: item.price,
      qty: 0
    };

    let newQty = existing.qty + delta;
    if (newQty < 0) newQty = 0;
    existing.qty = newQty;

    if (newQty === 0) {
      delete table.orders[orderKey];
    } else {
      table.orders[orderKey] = existing;
    }

    // 飲み放題 시간 처리
    if (item.isNomihodai) {
      if (existing.qty > 0 && !table.nomihodaiStart) {
        table.nomihodaiStart = new Date();
      }
      if (existing.qty === 0) {
        table.nomihodaiStart = null;
        table.nomihodaiMemo = "";
      }
    }

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 주문 조작: 소프트드링크 전메뉴
   *************************************************************/
  function addSoftDrink(itemId, inputEl) {
    const table = getCurrentTableState();
    if (!table) return;
    const item = itemsIndex[itemId];
    if (!item) return;
    const label = (inputEl.value || "").trim();
    if (!label) {
      alert("소프트드링크 메뉴명을 입력해주세요.");
      return;
    }

    const orderKey = `${itemId}::${label}`;
    const displayName = `${item.name} - ${label}`;

    const existing = table.orders[orderKey] || {
      itemId,
      name: displayName,
      price: item.price,
      qty: 0,
      softName: label
    };
    existing.qty += 1;
    table.orders[orderKey] = existing;

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 주문 조작: 카테고리별 임의 금액
   *************************************************************/
  function addCustomItem(categoryName, descInput, amountInput) {
    const table = getCurrentTableState();
    if (!table) return;

    const desc = (descInput.value || "").trim();
    const amount = parseInt(amountInput.value, 10);

    if (!amount || amount <= 0) {
      alert("유효한 금액(円)을 입력해주세요.");
      return;
    }

    const label = desc
      ? `${desc}`
      : `${categoryName} 임의 항목`;

    const orderKey = `custom::${Date.now()}::${Math.random().toString(36).slice(2,7)}`;

    table.orders[orderKey] = {
      itemId: "custom",
      name: `【임의】${label}`,
      price: amount,
      qty: 1,
      category: categoryName
    };

    descInput.value = "";
    amountInput.value = "";

    updateCurrentTableView();
    saveAppState();
  }

  /*************************************************************
   * 화면 갱신 / 합계 / 飲み放題 표시
   *************************************************************/
  function updateCurrentTableView() {
    const table = getCurrentTableState();
    const currentTableName = document.getElementById("currentTableName");
    const totalAmountEl = document.getElementById("totalAmount");
    const summaryList = document.getElementById("summaryList");
    const nomihodaiInfo = document.getElementById("nomihodaiInfo");
    const nomihodaiTimes = document.getElementById("nomihodaiTimes");
    const nomihodaiMemo = document.getElementById("nomihodaiMemo");

    // 모든 수량표시 0으로 초기화
    document.querySelectorAll("[data-qty-for]").forEach(span => {
      span.textContent = "0";
    });

    if (!table) {
      currentTableName.textContent = "선택된 테이블 없음";
      totalAmountEl.textContent = "합계: 0 円";
      summaryList.innerHTML = "";
      nomihodaiInfo.style.display = "none";
      return;
    }

    currentTableName.textContent = `현재 테이블: ${table.displayName}`;

    let total = 0;
    summaryList.innerHTML = "";

    Object.entries(table.orders).forEach(([orderKey, order]) => {
      const lineTotal = order.price * order.qty;
      total += lineTotal;

      // 일반 메뉴 수량 업데이트 (soft/custom 제외)
      if (!order.softName && order.itemId !== "custom") {
        document.querySelectorAll(`[data-qty-for="${order.itemId}"]`)
          .forEach(span => span.textContent = String(order.qty));
      }

      const row = document.createElement("div");
      row.className = "summary-item";

      const nameSpan = document.createElement("span");
      nameSpan.className = "summary-name";
      nameSpan.textContent = order.name;

      const infoSpan = document.createElement("span");
      infoSpan.className = "summary-info";
      infoSpan.textContent = `${order.qty}개 = ${lineTotal.toLocaleString()} 円`;

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "삭제";
      delBtn.onclick = () => deleteOrder(orderKey);

      row.appendChild(nameSpan);
      row.appendChild(infoSpan);
      row.appendChild(delBtn);
      summaryList.appendChild(row);
    });

    totalAmountEl.textContent = `합계: ${total.toLocaleString()} 円`;

    // 飲み放題 표시
    if (table.nomihodaiStart) {
      nomihodaiInfo.style.display = "block";
      const start = table.nomihodaiStart;
      const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);
      nomihodaiTimes.textContent =
        `시작: ${formatTime(start)}  /  종료 예정: ${formatTime(end)}`;
      nomihodaiMemo.value = table.nomihodaiMemo || "";
    } else {
      nomihodaiInfo.style.display = "none";
      nomihodaiMemo.value = "";
    }
  }

  function deleteOrder(orderKey) {
    const table = getCurrentTableState();
    if (!table) return;
    const order = table.orders[orderKey];
    if (!order) return;

    const item = itemsIndex[order.itemId];
    if (item && item.isNomihodai) {
      table.nomihodaiStart = null;
      table.nomihodaiMemo = "";
    }

    delete table.orders[orderKey];
    updateCurrentTableView();
    saveAppState();
  }

  function resetCurrentTable() {
    const table = getCurrentTableState();
    if (!table) return;
    table.orders = {};
    table.nomihodaiStart = null;
    table.nomihodaiMemo = "";
    updateCurrentTableView();
    saveAppState();
  }

  function updateNomihodaiMemo(value) {
    const table = getCurrentTableState();
    if (!table) return;
    table.nomihodaiMemo = value;
    saveAppState();
  }

  function formatTime(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const hh = String(date.getHours()).padStart(2, "0");
    const mm = String(date.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }

  window.onload = init;
</script>
</body>
</html>
